stages:
 - build
 - test
 - deploy

build:
  stage: build
  image: docker:latest
  services: 
    - docker:dind
  script:
    - if [ "$( docker container inspect -f '{{.State.Running}}' vane )" == "true" ]; then docker stop vane; fi
    - docker build . -f ci/Dockerfile.ci -t vane:latest --build-arg UID=$(id -u) --build-arg GID=$(id -g)
    - docker run -t -d --rm --name vane vane:latest

unit_tests:
  stage: test
  script:
    - docker exec -i vane pwd
    - docker exec -i vane bash -c "pytest --cov-report html --cov-report xml:cov.xml --junit-xml=junit.xml --cov=/project/vane/bin tests"
    - docker exec -i vane bash -c "pytest --cov=/project/vane/bin tests"
    - docker exec -i vane bash -c "coverage report -m "
    - docker exec -i vane bash -c "coverage-badge"
    - docker exec -i vane bash -c "ls"
    - docker cp vane:/project/htmlcov .
    - docker cp vane:/project/junit.xml .
    - docker cp vane:/project/cov.xml .
    - ls
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    paths:
      - htmlcov
      - junit.xml
      - cov.xml
    # reports:
    #  junit: junit.xml

system_tests:
  stage: test
  script:
    - docker exec -i vane pwd
    - docker exec -i vane bash -c "ls /project/vane"
    - docker exec -i vane bash -c "ls /project/vane/bin"
    - docker exec -i vane bash -c "ls /project/vane/reports"
    # - docker exec -i vane bash -c "cd /project/vane/bin && ./vane.py"

pages:
  stage: deploy
  script:
    - mv htmlcov/ public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
