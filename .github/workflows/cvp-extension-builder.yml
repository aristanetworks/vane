name: cvp-extension-builder
run-name: Build CVP extension RPM package

# Run the unittests when a pull request is merged, and post the coverage
# results badge to the repo page

on:
  push:
    branches:
      - gar-cvp-package
    # branches:
    #   - main

jobs:

  create_centos_build_container:

    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

      - name: Build the Centos container for creating the RPM images and push to GitHub container registry
        run: |
          docker build -t ghcr.io/aristanetworks/vane-cvp-build:latest -f Dockerfile.build-CVP . --build-arg UID=$(id -u) --build-arg GID=$(id -g)
          docker push ghcr.io/aristanetworks/vane-cvp-build:latest

  create_cvp_container:

    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build the CVP Vane container and save it as a tar.gz file
        run: |
          docker build -t vane-cvp -f Dockerfile.CVP . --network=host
          docker save vane-cvp | gzip > vane-cvp.tar.gz

      - name: Upload the CVP Vane container tar.gz artifact for later use
        uses: actions/upload-artifact@v3
        with:
          name: vane-cvp-gz
          path: vane-cvp.tar.gz

  package_cvp_container:

    needs: [create_centos_build_container, create_cvp_container]

    runs-on: ubuntu-latest
    steps:
      - name: Download the CVP Vane container tar.gz artifact we created in the previous job
        uses: actions/download-artifact@v3
        with:
          name: vane-cvp-gz

      - name: List the directory
        run: ls -la
